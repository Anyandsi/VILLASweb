image: docker

services:
- docker:dind

before_script:
- docker info
- mkdir build
- mkdir node_modules

cache:
  paths:
  - build
  - node_modules

stages:
- build
- test

build_job:
  stage: build
  script:
  - docker run --rm -v $(pwd)/package.json:/usr/src/app/package.json -v $(pwd)/build:/usr/src/app/build -v $(pwd)/public:/usr/src/app/public -v $(pwd)/src:/usr/src/app/src -w /usr/src/app node:7.9.0-slim bash -c 'npm install; npm run build'

test_job:
  stage: test
  script:
  - docker run --rm -v $(pwd)/package.json:/usr/src/app/package.json -v $(pwd)/public:/usr/src/app/public -v $(pwd)/src:/usr/src/app/src -w /usr/src/app node:7.9.0-slim bash -c 'npm install; npm test'
